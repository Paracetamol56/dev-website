---
title: Raspberry Pi fan controller with Python
description: A simple python script to control a fan connected to a Raspberry Pi
categories:
  - raspberry-pi
  - self-hosting
published: true
---

<script>
  import CodeBlock from '$lib/components/CodeBlock.svelte';
</script>

## Introduction

Running a raspberry pi server 24/7 without any cooling system is not recomanded.
When I setup my raspberry pi server, I used passive cooling with a nice heatsink covering the entire SBC (Single Board Computer).
But, relying on the ambient air temperature is not a good idea, especially in summer when the indoor temperature can reach up to 30°C (86°F).
and when your Raspberry Pi is enclosed in a 3D printed case in PLA like me.

I decided to buy a Noctua NF-A4x20 5V PWM fan and build my own fan controller using a python script and a bit of electronics.

## Hardware

- Raspberry Pi 4 (4GB)
- Passive cooling heatsink [Amazon](https://www.amazon.fr/gp/product/B07VXJLW4X/ref=ppx_yo_dt_b_asin_title_o00_s00?ie=UTF8&psc=1)
  Note that this heatsink is not meant to be used with a fan, other models are available with dedicated fan support.
- Noctua NF-A4x20 5V PWM fan [Amazon](https://www.amazon.fr/gp/product/B071W6HJP6/ref=ppx_yo_dt_b_asin_title_o00_s00?ie=UTF8&psc=1)
- A NPN transistor (S8050 but you are free to use any other model)
- A 1K resistor
- A diode

## Wiring

I chose to use GPIO 14 to drive the fan using PWM (Pulse Width Modulation) since it is physically close to the 5V and GND pins.
The Raspberry Pi GPIO pins can only provide 3.3V and 16mA, which is not enough to drive the fan.
That's why the PWM signal is generated by the Raspberry Pi is fed to the base of the NPN transistor which acts as a high frequency switch to control the fan.
The diode is used to protect the transistor from the back EMF (ElectroMotive Force) generated by the fan.
And the resistor is used to limit the current flowing into the base of the transistor.

Here is the wiring diagram:
![Wiring diagram](/img/raspberry-pi-fan-controller/wiring-diagram.png)
![Schematic](/img/raspberry-pi-fan-controller/schematic.png)
## Software

### Temperature sensor

First of all, we need a way to get the CPU temperature of the Raspberry Pi.
For this purpose, we will use the `vcgencmd` command line tool.

To install it, run the following command (for Debian based distributions):

<CodeBlock>

```bash
sudo apt install vcgencmd
```

</CodeBlock>

Then, test it by running:

<CodeBlock>

```bash
vcgencmd measure_temp
```

</CodeBlock>

If everything is working, you should see the CPU temperature in Celsius degrees.
The next step is to get this value in a python script.
To do so, we will use the `os` module to run the command with `os.popen()` and the `readline()` method to get the output.

This is the code to do just that and format the output:

<CodeBlock>

```py
import os

def getCpuTemperature():
    res = os.popen('vcgencmd measure_temp').readline()
    temp =(res.replace("temp=","").replace("'C\n",""))
    print("temp is {0}".format(temp))
    return temp
```

</CodeBlock>

### Regulation algorithm

Now that we have a way to get the CPU temperature, we need to implement a regulation algorithm to control the fan speed.
The algorithm is quite simple and can be summarized in 3 steps:
- Turn off the fan if temperature is below a constant value (`MIN_TEMP`)
- Set fan speed to maximum if the temperature is above a constant value (`MAX_TEMP`)
- Interpolate the fan speed between `FAN_LOW` and `FAN_HIGH` if the temperature is between `MIN_TEMP` and `MAX_TEMP`

[Linear interpolation](https://en.wikipedia.org/wiki/Linear_interpolation) is a basic mathematical technique that can be used to compute a value between two known values.
![Linear interpolation](/img/raspberry-pi-fan-controller/LinearInterpolation.svg)

$$\frac{y-y_{0}}{x-x_{0}}=\frac{y_{1}-y_{0}}{x_{1}-x_{0}}$$
$$\Leftrightarrow y=y_{0}+\frac{y_{1}-y_{0}}{x_{1}-x_{0}}(x-x_{0})$$

Let's put this into practice and write a function to compute the fan speed:

<CodeBlock>

```py
# Configurable temperature and fan speed
MIN_TEMP = 35
MAX_TEMP = 65
FAN_LOW = 40
FAN_HIGH = 100
FAN_OFF = 0
FAN_MAX = 100

def handleFanSpeed():
    temp = float(getCpuTemperature())
    # Turn off the fan if temperature is below MIN_TEMP
    if temp < MIN_TEMP:
        setFanSpeed(FAN_OFF)
        print("Fan OFF")
    # Set fan speed to MAXIMUM if the temperature is above MAX_TEMP
    elif temp > MAX_TEMP:
        setFanSpeed(FAN_MAX)
        print("Fan MAX")
    # Caculate dynamic fan speed
    else:
        speed = FAN_LOW + (temp - MIN_TEMP) * (FAN_HIGH - FAN_LOW) / (MAX_TEMP - MIN_TEMP)
        setFanSpeed(speed)
        #print(speed) # Uncomment for testing
```

</CodeBlock>

Note that some testing is required to find the best values for `FAN_LOW` (when the fan starts spinning), `MIN_TEMP` and `MAX_TEMP`

### Fan control

Last but not least, we need to control the GPIO pin to drive the fan using PWM.

> PWM (Pulse Width Modulation) is a method used for getting variable voltage out of constant power source. The average value of voltage (and current) fed to the load is controlled by turning the switch between supply and load on and off at a fast rate. The longer the switch is on compared to the off periods, the higher the total power supplied to the load. The PWM switching frequency has to be much faster than what would affect the load. [Go further](https://www.electronics-tutorials.ws/blog/pulse-width-modulation.html)

We will use the `RPi.GPIO` python module to control the GPIO pin.
First, we need to initialize the GPIO pin and set the PWM frequency.
Then, we can create an infinite loop to call the `handleFanSpeed()` function every x seconds and set the fan speed accordingly.

<CodeBlock>

```py
import RPi.GPIO as GPIO
import time

def setFanSpeed(speed):
    fan.start(speed)
    return()

GPIO.setwarnings(False)
GPIO.setmode(GPIO.BCM)
GPIO.setup(FAN_PIN, GPIO.OUT, initial=GPIO.LOW)
fan = GPIO.PWM(FAN_PIN,PWM_FREQ)
setFanSpeed(FAN_OFF)

while True:
    handleFanSpeed()
    time.sleep(WAIT_TIME)
```

</CodeBlock>

### Final code

<CodeBlock>

```py
#! /usr/bin/python
# PWM fan speed controller

import RPi.GPIO as GPIO
import time
import signal
import sys
import os

# Configuration
FAN_PIN = 14            # BCM pin used to drive PWM fan
WAIT_TIME = 10          # [s] Time to wait between each refresh
PWM_FREQ = 25           # [kHz] 25kHz for Noctua PWM control

# Configurable temperature and fan speed
MIN_TEMP = 35
MAX_TEMP = 65
FAN_LOW = 40
FAN_HIGH = 100
FAN_OFF = 0
FAN_MAX = 100

# Get CPU's temperature
def getCpuTemperature():
    res = os.popen('vcgencmd measure_temp').readline()
    temp =(res.replace("temp=","").replace("'C\n",""))
    #print("temp is {0}".format(temp)) # Uncomment for testing
    print("temp:", temp)
    return temp

# Set fan speed
def setFanSpeed(speed):
    print("speed:", speed)
    fan.start(speed)
    return()

# Handle fan speed
def handleFanSpeed():
    temp = float(getCpuTemperature())
    # Turn off the fan if temperature is below MIN_TEMP
    if temp < MIN_TEMP:
        setFanSpeed(FAN_OFF)
        #print("Fan OFF") # Uncomment for testing
    # Set fan speed to MAXIMUM if the temperature is above MAX_TEMP
    elif temp > MAX_TEMP:
        setFanSpeed(FAN_MAX)
        #print("Fan MAX") # Uncomment for testing
    # Compute the fan speed for temperatures between MIN_TEMP and MAX_TEMP
    else:
        speed = FAN_LOW + (temp - MIN_TEMP) * (FAN_HIGH - FAN_LOW) / (MAX_TEMP - MIN_TEMP)
        setFanSpeed(speed)
        #print(speed) # Uncomment for testing
    return ()

try:
    # Setup GPIO pin
    GPIO.setwarnings(False)
    GPIO.setmode(GPIO.BCM)
    GPIO.setup(FAN_PIN, GPIO.OUT, initial=GPIO.LOW)
    fan = GPIO.PWM(FAN_PIN,PWM_FREQ)
    setFanSpeed(FAN_OFF)
    # Handle fan speed every WAIT_TIME sec
    while True:
        handleFanSpeed()
        time.sleep(WAIT_TIME)

except KeyboardInterrupt: # trap a CTRL+C keyboard interrupt
    setFanSpeed(FAN_HIGH)
    #GPIO.cleanup() # resets all GPIO ports
```

</CodeBlock>

### One last thing: run the script as a service

Now that the script is working, we need to run it as a service to be able to start, stop, restart and last but not least, start on boot.

Debian based distributions use `systemd` to manage services.
To create a service, we need to create a file in `/etc/systemd/system/` with the `.service` extension.

<CodeBlock>

```bash
[Unit]
Description=Fan speed controller
After=multi-user.target

[Service]
User=root
Group=root
Type=simple
ExecStart=/usr/bin/python /home/pi/fan_controller.py
Restart=always

[Install]
WantedBy=multi-user.target
```

</CodeBlock>

Then, we need to reload the daemon and enable the service:

<CodeBlock>

```bash
systemctl daemon-reload
systemctl enable fan_controller.service # Enable (start on boot)
systemctl status fan_controller.service # Check the status
```

</CodeBlock>
